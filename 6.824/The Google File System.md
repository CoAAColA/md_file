# The Google File System

## 1 INTRODUCTION

目标：性能、可拓展性、可靠性、可用性、

和早期文件系统设计的区别：

1. 组件失效是正常现象而不是异常现象。因此，**持续检测、错误检测、容错、自动恢复**必须集成到这个系统中。
2. 以传统标准来看，文件是巨大的，同时会有许多KB大小的文件需要管理。因此设计假设和参数、如I/O操作和快大小，不得不被重新审视
3. 大多数文件被修改的方式是**追加新数据而不是重写原数据**。文件内的随机写操作实际上是不存在的。一旦写入，这些文件就仅会被读取，而且通常只按顺序读取。由于这种对大型文件的访问模式，追加成为性能优化和原子性保证的重点，而在客户机中缓存数据块则失去了吸引力
4. 我们在GFS上使用弱一致性模型来大大简化这个文件系统而没有给应用程序带来繁重的负担。我们还引入了一个原子追加操作能够使多个客户端之间**并发地对同一个文件追加而不需要额外的同步机制**

## 2 DESIGN OVERVIEW

### 2.1 Assumptions

* 系统构建于许多经常失效的商业组件上。系统必须持续监测自身并且检测，容错，恢复
* 系统存储数量适中的大文件。较大的文件应该被高效地管理。小文件必须被支持，但是不需要进行优化
* 工作负载主要由两种类型的读取操作组成：大规模流读取和小规模随机读取。性能敏感的应用程序通常对小规模读取进行批处理和排序，从而能够稳定地遍历文件而不是来回切换
* 工作负载还包含许多对文件进行追加数据的大规模、顺序的写操作。一旦写入，文件就很少会被修改。在文件的任意位置进行小规模地写操作是被支持的，但是不必是高效的
* 系统必须针对多个客户端并发追加到相同文件高效地实现具有良好定义的语义。具有**最小同步开销的原子性**是至关重要的。文件可能是稍后读取，或者一个消费者可能同时读取该文件
* 高持续带宽比低延迟重要许多。

### 2.2 Interface

除了熟悉的文件系统接口外，GFS还有快照和记录追加操作。快照以低开销创建一个文件或目录树的拷贝。记录追加允许多个客户端并发地对同一个文件进行追加数据，同时保证每个独立客户端的追加操作的原子性。

### 2.3 Architecture

一个GFS集群由一个`master`和多个`chunkserver`组成并被多个客户端访问，如下图所示：

![image-20230914110042378](/home/liam/.config/Typora/typora-user-images/image-20230914110042378.png)

文件被分成固定大小的块。出于可靠性的要求，每个块在多个`chunkserver`上复制。默认情况下，我们存储三份副本

`master`维护文件系统所有的元数据。`master`以心跳消息的方式周期性地和每个`chunkserver`进行通信，下达指令并收集其状态信息

客户端和`chunkserver`都不缓存文件数据。客户端的缓存几乎提供不了多少好处，因为大多数应用程序都要处理巨大的文件或者工作集太大而无法缓存。没有文件缓存可以消除一致性问题，从而简化客户端和整个系统（尽管如此，客户端会缓存元数据）。`chunkserver`不需要缓存文件数据是因为块作为本地文件被存储，所以Linux的buffer cache已经将经常访问的数据保存在内存中。

### 2.4 Single Master

使用单个`master`极大地简化了我们的设计，并使`master`能够使用全局知识作出复杂的块放置和复制决策。尽管如此，我们必须最小化它对读写的参与，从而不至于成为瓶颈。客户端从不通过`master`读写文件数据。客户端会询问`master`它应该联系哪个`chunkserver`。客户端把这个信息缓存一段有限的时间，然后直接和`chunkserver`交互以进行后续的操作。

首先客户端用固定的块大小将应用程序指定的文件名和字节偏移量转换成一个文件内的块索引。然后它将文件名和块索引发送给`master`。`master`回复对应的块句柄和副本的位置。客户端使用文件名和块索引作为key缓存这条信息。

客户端接着发送一个请求到其中一个副本，最可能是最近的那个。请求指定了一个块句柄和一个对应块内的字节区间。对同一个块的读取将不需要客户端到`master`的交互，直到缓存信息失效或者文件被重打开。客户端通常会在同一个请求中请求多个块，并且`master`也可以包含这些块的之后的块的信息。这些额外的信息几乎不需要额外开销就可以避免未来几次客户端到`master`的交互

### 2.5 Chunk Size

每个块的副本都作为一个普通linux文件存储在`chunkserver`上并且只在需要的时候进行拓展。惰性空间分配避免了因内部碎片而浪费空间，这可能是对如此大的块大小的最大反对。

较大的块的优势有几个：

1. 减少了客户端和`master`交互的需求，
2. 在较大的块上，客户端能执行更多操作，因此可以通过和`chunkserver`保持更长时间的TCP连接来减少网络开销
3. 减少了存储在`master`的元数据大小

较大的块的也有它的缺点，一个较小的文件可能就一个块，如果多个客户端正在访问同一个文件，存储这些块的`chunkserver`可能会成为`hot spot`。但是因为我们的应用程序主要是顺序读取较大的具有多个块的文件，所以一般没有`hot spot`问题。

如果遇上了`hot spot`问题，那么我们可以考虑增加对应小文件的复制因子来存储它。一个潜在的长期解决方案是允许客户端在这种情况下从其他客户端读取数据

### 2.6 Metadata

`master`存储了三种主要类型的元数据：文件和块命名空间，文件到块的映射，以及每个块的副本的位置。所有的元数据都保存在`master`的内存中。前两种类型也会通过将变更几率到存储在`master`本地磁盘的操作日志上而持久化保存，并且被复制到远端机器。`master`不会对块位置信息进行持久化存储。

#### 2.6.1 In-Memory Data Structures

`master`可以见打高效地在后台周期性扫描它的记录状态。这个周期性扫描用于实现块的垃圾回收，在`chunkserver`失效时进行重新复制，以及块迁移，块迁移是为了在`chunkserver`之间均衡负载和磁盘空间使用

#### 2.6.2 Chunk Locations

`master`在启动时对`chunkserver`轮询块的位置信息，`master`通过周期性的心跳信息控制所有块的放置并监控`chunkserver`状态。

#### 2.6.3 Operation Log

### 2.7 Consistency Model

## 3 SYSTEM INTERACTIONS

#### 3.2 Data Flow

我们将数据流从控制流中分离出来从而高效地使用网络，控制流从客户端到`primary`然后再到所有的从副本，而数据流以流水线的方式在精心挑选的`chunkserver`链之间被线性地推送。我们的目标是充分利用每台机器的网络带宽，避免网络瓶颈和高延迟链路，并且最小化所有数据的推送时延

## 4 MASTER OPERATION

### 4.2 Replica Placement

块副本放置策略有两个目标：最大化数据可靠性与可用性和最大化网络带宽利用率。对于这两种情况，仅仅将副本分布于不同的机器上是不够的，这仅能应对磁盘或机器故障和充分利用每台机器的网络带宽。我们必须还要把副本分布于不同的机架上。这样可以确保在整个机架被损坏或者离线的情况下（例如，由于像网络交换机或电源电路等共享资源的故障），一个块的某些副本仍然存活并保持可用。这也意味着一个块的流量，尤其是读，**可以利用多个机架的总带宽**。另一方面，**写流量必须流经多个机架**，这是我们心甘情愿做出的取舍。

### 4.3  Creation, Re-replication, Rebalancing

创建块副本有三个原因：块创建、再复制、以及再平衡

### 4.4 Garbage Collection

当一个文件被删除后，GFS不会立即回收可用的物理存储空间。它只是在文件和块层级的周期性垃圾收集过程中进行惰性回收。

#### 4.4.1 Mechanism

当一个文件被应用程序删除时，`master`会像其他更改一样立即记录删除操作。但不会立即去删除对应资源，而是将其重新命名为一个包含删除时间戳的隐藏名称。经过一个可配置的时间间隔后，这个文件将会被删除。在这之前，该文件仍然可以通过新的特殊名称来读取，并且可以通过将其重新命名为正常名称来取消删除。当隐藏的文件从命名空间中删除时，它在内存中的元数据也会被删除。这就有效地切断了它和它所有的块之间的链接

`master`还会识别出孤儿块，并且擦出这些块的元数据。在和`master`周期性交换的心跳消息中，每个 chunkserver 报告它拥有的块的子集，master 则回复在其元数据中不再存在的所有块的标识。**chunkserver 可以自由删除这类块的副本**。

### 4.5 Stale Replica Detection

如果chunkserver失效以及在其宕机期间错过块的变更，块副本就变得过期（stale）。对于每个块，master维护了一个**块版本号（chunk version number）** 来区分最新和过期的副本。

每当`master`赋予一个块新的租约时，它会增加块版本号并通知最新的副本。

`master`会在其周期性的垃圾回收中移除过期的副本

